/*
 * polgahavela 5500.cpp
 *
 * Created: 10/20/2021 1:58:11 PM
 * Author : dilan
 */ 
#define F_CPU 8000000
#include <avr/io.h>
#include <util/delay.h>
#include <stdio.h>
 char lcd[15]={0};
	 char lcd1[15]={0};
uint16_t chart[231]={
	0	,
	13	,
	38	,
	70	,
	108	,
	152	,
	200	,
	252	,
	309	,
	368	,
	432	,
	499	,
	569	,
	641	,
	717	,
	795	,
	877	,
	960	,
	1046	,
	1135	,
	1225	,
	1318	,
	1414	,
	1511	,
	1610	,
	1712	,
	1815	,
	1920	,
	2027	,
	2136	,
	2247	,
	2359	,
	2473	,
	2589	,
	2706	,
	2825	,
	2945	,
	3067	,
	3190	,
	3315	,
	3441	,
	3569	,
	3698	,
	3828	,
	3959	,
	4092	,
	4226	,
	4361	,
	4498	,
	4635	,
	4774	,
	4914	,
	5055	,
	5197	,
	5340	,
	5484	,
	5629	,
	5775	,
	5922	,
	6070	,
	6219	,
	6368	,
	6519	,
	6671	,
	6823	,
	6976	,
	7130	,
	7285	,
	7440	,
	7596	,
	7753	,
	7911	,
	8069	,
	8228	,
	8388	,
	8548	,
	8709	,
	8871	,
	9033	,
	9195	,
	9359	,
	9522	,
	9687	,
	9852	,
	10017	,
	10183	,
	10349	,
	10515	,
	10682	,
	10850	,
	11018	,
	11186	,
	11355	,
	11524	,
	11693	,
	11862	,
	12032	,
	12202	,
	12373	,
	12543	,
	12714	,
	12886	,
	13057	,
	13228	,
	13400	,
	13572	,
	13744	,
	13916	,
	14088	,
	14261	,
	14433	,
	14606	,
	14778	,
	14951	,
	15124	,
	15296	,
	15469	,
	15642	,
	15814	,
	15987	,
	16160	,
	16332	,
	16504	,
	16677	,
	16849	,
	17021	,
	17193	,
	17364	,
	17536	,
	17707	,
	17878	,
	18049	,
	18220	,
	18390	,
	18561	,
	18730	,
	18900	,
	19069	,
	19238	,
	19407	,
	19575	,
	19743	,
	19910	,
	20077	,
	20244	,
	20410	,
	20576	,
	20741	,
	20906	,
	21070	,
	21234	,
	21397	,
	21560	,
	21722	,
	21884	,
	22045	,
	22205	,
	22365	,
	22524	,
	22682	,
	22840	,
	22997	,
	23153	,
	23308	,
	23463	,
	23617	,
	23770	,
	23922	,
	24074	,
	24224	,
	24374	,
	24523	,
	24671	,
	24818	,
	24964	,
	25109	,
	25253	,
	25396	,
	25538	,
	25679	,
	25819	,
	25958	,
	26095	,
	26232	,
	26367	,
	26501	,
	26634	,
	26765	,
	26895	,
	27024	,
	27152	,
	27278	,
	27403	,
	27526	,
	27648	,
	27768	,
	27887	,
	28004	,
	28120	,
	28234	,
	28346	,
	28457	,
	28566	,
	28673	,
	28778	,
	28881	,
	28983	,
	29082	,
	29179	,
	29274	,
	29367	,
	29458	,
	29547	,
	29633	,
	29716	,
	29797	,
	29876	,
	29952	,
	30024	,
	30094	,
	30161	,
	30224	,
	30284	,
	30341	,
	30393	,
	30441	,
	30484	,
	30523	,
	30555	,
	30579	,
	30593	
};


#include "USART.h"
#include "LCDI2C.h"

bool back=0;

int main(void)
{
	_delay_ms(500);
    USART_Init(9600);
	LcdInit();
	LcdSetCursor(0,0,"Dis:");
	_delay_ms(50);
	LcdSetCursor(0,1,"Vol:");
	_delay_ms(500);
	
	    while (1) 
    {
		USART_TxString("U");
		_delay_ms(150);
		
		uint16_t length=distance;
		if (length>2300)
		{length=2300;
		} 
		
		
		uint16_t height=2300-length;
		if ((height<840)&&(height!=0))
		{	back=!back;
			LcdBacklight(back);
		} 
		else
		{LcdBacklight(1);
		}
		sprintf(lcd,"%04umm   %03u",height,length/10);
		LcdSetCursor(4,0,lcd);
		uint16_t cbm=chart[height/10];
		uint32_t percent=(cbm*0.003268721603);
		sprintf(lcd1,"%05u    %02u%%",cbm,percent);
		LcdSetCursor(4,1,lcd1);
			
    }
}

